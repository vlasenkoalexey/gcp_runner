---

title: Google Cloud Platform notebook runner for [nbdev](https://github.com/fastai/nbdev/tree/master/nbdev)

keywords: fastai
sidebar: home_sidebar

summary: "Allows running any Jupyter notebook function on Google Cloud Platform."
description: "Allows running any Jupyter notebook function on Google Cloud Platform."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span>git clone https://github.com/vlasenkoalexey/gcp_runner
pip install -e gcp_runner

<span class="c1">#TODO: upload to pypi</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's define some function that we want to run in notebook as well as on Google Cloud.
Note that cell has to be marked with export attribute:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="some_function_to_run_on_cloud" class="doc_header"><code>some_function_to_run_on_cloud</code><a href="https://github.com/users/gcp_runner/tree/master/gcp_runner/index.py#L8" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>some_function_to_run_on_cloud</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Running it in notebook as usual:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">some_function_to_run_on_cloud</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>running some_function_to_run_on_cloud
in main before sleep 1
in main after sleep 2
in main after sleep 3
in main after sleep 4
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Updating-project">Updating project<a class="anchor-link" href="#Updating-project"> </a></h3><p>If you do any changes, call <code>gcp_runner.core.export_and_reload_all</code> to convert all notebooks to python, and reload all modules. Note that modules are reloaded in an order defined by notebook names to make sure that dependencies are processed correctly. If there are errors in one of the modules, you can ignore them by setting ignore_errors=True. Or just restart Kernel.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">gcp_runner.core</span> <span class="k">import</span> <span class="n">export_and_reload_all</span>
<span class="n">export_and_reload_all</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Testing-code-locally">Testing code locally<a class="anchor-link" href="#Testing-code-locally"> </a></h3><p>Test that code can be executed locally as a Python script:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">gcp_runner.local_runner</span>
<span class="n">gcp_runner</span><span class="o">.</span><span class="n">local_runner</span><span class="o">.</span><span class="n">run_python</span><span class="p">(</span><span class="n">some_function_to_run_on_cloud</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>in gcp_runner entry point
running entrypoint function: gcp_runner.index.some_function_to_run_on_cloud
running some_function_to_run_on_cloud
in main before sleep 1
in main after sleep 2
in main after sleep 3
in main after sleep 4
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Or you can test that code can be executed locally as a docker container.
In order to build your own Docker file, set <code>build_docker_file</code> argument:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">gcp_runner.local_runner</span>
<span class="n">gcp_runner</span><span class="o">.</span><span class="n">local_runner</span><span class="o">.</span><span class="n">run_docker</span><span class="p">(</span>
    <span class="n">some_function_to_run_on_cloud</span><span class="p">,</span>
    <span class="s1">&#39;gcr.io/deeplearning-platform-release/tf2-cpu.2-1&#39;</span><span class="p">,</span>
    <span class="n">build_docker_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<pre>
Running in Docker container:  
docker run -v /usr/local/google/home/alekseyv/vlasenkoalexey/gcp_runner/gcp_runner:/gcp_runner gcr.io/deeplearning-platform-release/tf2-cpu.2-1 python -u -m gcp_runner.entry_point --module-name=gcp_runner.index --function-name=some_function_to_run_on_cloud
in gcp_runner entry point  
running entrypoint function: gcp_runner.index.some_function_to_run_on_cloud  
running some_function_to_run_on_cloud  
in main before sleep 1  
in main after sleep 2  
in main after sleep 3  
in main after sleep 4 
</pre>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Running-on-Google-Cloud-AI-Platform">Running on Google Cloud AI Platform<a class="anchor-link" href="#Running-on-Google-Cloud-AI-Platform"> </a></h3><p>TODO: describe google cloud sdk setup</p>
<p>Running as a package on Google Cloud AI Platform:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">gcp_runner.ai_platform_runner</span>

<span class="n">gcp_runner</span><span class="o">.</span><span class="n">ai_platform_runner</span><span class="o">.</span><span class="n">run_package</span><span class="p">(</span>
     <span class="n">some_function_to_run_on_cloud</span><span class="p">,</span> 
     <span class="s1">&#39;gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<pre>
Trimmed output:  
Running training job using package on Google Cloud Platform AI:  
gcloud ai-platform jobs submit training ai_platform_runner_train_package_20200327_131147 \\  
 --runtime-version=2.1 \\   
 --python-version=3.7 \\   
 --stream-logs \\   
 --module-name=gcp_runner.entry_point \\   
 --package-path=/usr/local/google/home/alekseyv/vlasenkoalexey/gcp_runner/gcp_runner \\  
 --job-dir=gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir \\  
 --scale-tier=basic \\  
 --use-chief-in-tf-config=True \\  
 -- \\  
 --job-dir=gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir \\  
 --module-name=gcp_runner.index \\  
 --function-name=some_function_to_run_on_cloud  

Job [ai_platform_runner_train_package_20200327_131147] submitted successfully.  
INFO    2020-03-27 13:11:51 -0700   service     Validating job requirements...  
INFO    2020-03-27 13:11:51 -0700   service     Job creation request has been successfully validated.  
INFO    2020-03-27 13:11:51 -0700   service     Job ai_platform_runner_train_package_20200327_131147 is queued.  
INFO    2020-03-27 13:11:51 -0700   service     Waiting for job to be provisioned.  
INFO    2020-03-27 13:11:53 -0700   service     Waiting for training program to start.  
...  
INFO    2020-03-27 13:13:23 -0700   master-replica-0        Running command: python3 -m gcp_runner.entry_point --job-dir=gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir --module-name=gcp_runner.index --function-name=some_function_to_run_on_cloud --job-dir gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        in gcp_runner entry point  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        running entrypoint function: gcp_runner.index.some_function_to_run_on_cloud  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        additional args: ['--job-dir=gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir', '--job-dir', 'gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir']  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        running some_function_to_run_on_cloud  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        in main before sleep 1  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        in main after sleep 2  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        in main after sleep 3  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        in main after sleep 4  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        Module completed; cleaning up.  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        Clean up finished.  
INFO    2020-03-27 13:13:35 -0700   master-replica-0        Task completed successfully.  
state: SUCCEEDED 
</pre>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Running as a custom Docker container on Google Cloud AI Platform:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">gcp_runner.ai_platform_runner</span>

<span class="n">gcp_runner</span><span class="o">.</span><span class="n">ai_platform_runner</span><span class="o">.</span><span class="n">run_docker_image</span><span class="p">(</span>
    <span class="n">some_function_to_run_on_cloud</span><span class="p">,</span>
    <span class="s1">&#39;gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir&#39;</span><span class="p">,</span>
    <span class="n">build_docker_file</span><span class="o">=</span><span class="s1">&#39;Dockerfile&#39;</span><span class="p">,</span>
    <span class="n">master_image_uri</span><span class="o">=</span><span class="s1">&#39;gcr.io/alekseyv-scalableai-dev/tf2-cpu.2-1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<pre>
Trimmed output:  
INFO    2020-03-27 13:01:57 -0700   master-replica-0        running some_function_to_run_on_cloud  
INFO    2020-03-27 13:01:57 -0700   master-replica-0        in main before sleep 1  
INFO    2020-03-27 13:01:59 -0700   master-replica-0        in main after sleep 2  
INFO    2020-03-27 13:02:04 -0700   master-replica-0        in main after sleep 3  
INFO    2020-03-27 13:02:09 -0700   master-replica-0        in main after sleep 4  
</pre>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>TODO: example how to run distributed training
TODO: example how to run distributed hyper parameter tuner</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Running-Google-Cloud-Kubernetes">Running Google Cloud Kubernetes<a class="anchor-link" href="#Running-Google-Cloud-Kubernetes"> </a></h3><ul>
<li>TODO: describe how to setup and configure Kubernetes</li>
<li>TODO: describe that it is faster to use Kubernetes for iterative work</li>
<li>TODO: distributed training</li>
<li>TODO: distributed HP tuning</li>
</ul>
<p>Note that Kubernetes doesn't offer convenient way of streaming logs, so currently script is going to keep pulling logs until you terminate it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">gcp_runner.kubernetes_runner</span>

<span class="n">gcp_runner</span><span class="o">.</span><span class="n">kubernetes_runner</span><span class="o">.</span><span class="n">run_docker_image</span><span class="p">(</span>
    <span class="n">some_function_to_run_on_cloud</span><span class="p">,</span>
    <span class="s1">&#39;gs://alekseyv-scalableai-dev-criteo-model-bucket/test-job-dir&#39;</span><span class="p">,</span>
    <span class="n">build_docker_file</span><span class="o">=</span><span class="s1">&#39;Dockerfile&#39;</span><span class="p">,</span>
    <span class="n">image_uri</span><span class="o">=</span><span class="s1">&#39;gcr.io/alekseyv-scalableai-dev/tf2-cpu.2-1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<pre>
Trimmed output:  
kubernetes-runner-train-docker-chief-0      running some_function_to_run_on_cloud  
kubernetes-runner-train-docker-chief-0      in main before sleep 1  
kubernetes-runner-train-docker-chief-0      in main after sleep 2  
kubernetes-runner-train-docker-chief-0      in main after sleep 3  
kubernetes-runner-train-docker-chief-0      in main after sleep 4  
</pre>
</div>
</div>
</div>
    {% endraw %}
</div>
 

